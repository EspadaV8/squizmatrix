<queries system="thesaurus">


	<query id="getChildThesaurusTerms">
		<!-- Get a list of terms that have a given term as their parent. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term" column="termid" />
					<field table="sq_thes_term" column="term" />
					<field table="sq_thes_lnk" column="linkid" />
					<field table="sq_thes_lnk" column="relid" />
				</fields>
				<from>
					<table>sq_thes_term</table>
					<table>sq_thes_lnk</table>
				</from>
				<joins>
					<join>
						<field table="sq_thes_term" column="termid" />
						<field table="sq_thes_lnk"  column="minor" />
					</join>
				</joins>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk"  column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk"  column="major">:termid</equal>
				</where>
				<order-by>
					<field table="sq_thes_term" column="term" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="countChildThesaurusLinks">
		<!-- Get a count of how many terms are linked directly underneath a given term. -->
		<primary>
			<select>
				<fields>
					<function name="Count">
						<arg><field table="sq_thes_lnk" column="linkid" /></arg>
					</function>
				</fields>
				<from>
					<table>sq_thes_lnk</table>
				</from>
				<where>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk" column="major">:termid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="getParentThesaurusTerms">
		<!-- Get a list of terms that have a given term as their immediate child. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term" column="termid" />
					<field table="sq_thes_term" column="term" />
					<field table="sq_thes_lnk" column="linkid" />
					<field table="sq_thes_lnk" column="relid" />
				</fields>
				<from>
					<table>sq_thes_term</table>
					<table>sq_thes_lnk</table>
				</from>
				<joins>
					<join>
						<field table="sq_thes_term" column="termid" />
						<field table="sq_thes_lnk"  column="minor" />
					</join>
				</joins>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk"  column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk"  column="minor">:termid</equal>
				</where>
				<order-by>
					<field table="sq_thes_term" column="term" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="countParentThesaurusLinks">
		<!-- Get a count of how many terms are linked directly ABOVE a given term. -->
		<primary>
			<select>
				<fields>
					<function name="Count">
						<arg><field table="sq_thes_lnk" column="linkid" /></arg>
					</function>
				</fields>
				<from>
					<table>sq_thes_lnk</table>
				</from>
				<where>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk" column="minor">:termid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="countAllThesaurusLinks">
		<!-- Count total number of links in a thesaurus. -->
		<primary>
			<select>
				<fields>
					<function name="Count">
						<arg><field table="sq_thes_lnk" column="linkid" /></arg>
					</function>
				</fields>
				<from>
					<table>sq_thes_lnk</table>
				</from>
				<where>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="deleteThesaurusLink">
		<!-- Delete a single thesaurus link. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
					<equal table="sq_thes_lnk" column="linkid">:linkid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="updateThesaurusTerm">
		<!-- Update a single thesaurus term. -->
		<primary>
			<update>
				<fields table="sq_thes_term">
					<field>term</field>
				</fields>
				<values>
					<value column="term">:name</value>
				</values>
				<where>
					<equal table="sq_thes_term" column="termid">:termid</equal>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
				</where>
			</update>
		</primary>
	</query>
	<query id="getAllThesaurusTerms">
		<!-- Get a list of all thesaurus terms. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term" column="termid" />
					<field table="sq_thes_term" column="term" />
				</fields>
				<from>
					<table>sq_thes_term</table>
				</from>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
				</where>
				<order-by>
					<field table="sq_thes_term" column="term" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="getThesaurusTermById">
		<!-- Get a single thesaurus term identified by term ID. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term" column="termid" />
					<field table="sq_thes_term" column="term" />
				</fields>
				<from>
					<table>sq_thes_term</table>
				</from>
				<where>
					<equal table="sq_thes_term" column="termid">:termid</equal>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="countAllThesaurusTerms">
		<!-- Count total number of terms in a thesaurus. -->
		<primary>
			<select>
				<fields>
					<function name="Count">
						<arg><field table="sq_thes_term" column="termid" /></arg>
					</function>
				</fields>
				<from>
					<table>sq_thes_term</table>
				</from>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="deleteThesaurusTerm">
		<!-- Delete a single thesaurus term. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
					<equal table="sq_thes_term" column="termid">:termid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="deleteThesaurusLinksContainingTerm">
		<!-- Delete all links that involve a certain thesaurus term. -->
		<primary>
			<delete>
				<where>
					<or>
						<equal table="sq_thes_lnk" column="minor">:termid</equal>
						<equal table="sq_thes_lnk" column="minor">:termid</equal>
					</or>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="updateThesaurusRelationName">
		<!-- Update the name of a thesaurus relation. -->
		<primary>
			<update>
				<fields table="sq_thes_rel">
					<field>relation</field>
				</fields>
				<values>
					<value column="relation">:relation</value>
				</values>
				<where>
					<equal table="sq_thes_rel" column="relid">:relid</equal>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
			</update>
		</primary>
	</query>
	<query id="deleteThesaurusRelation">
		<!-- Delete a thesaurus relation. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_rel" column="relid">:relation</equal>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="deleteThesaurusLinksContainingRelation">
		<!-- Delete all links that involve a certain deleted relation. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_lnk" column="relid">:relation</equal>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="getThesaurusLinkById">
		<!-- Get a link between two thesaurus terms by its link ID. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_lnk" column="linkid" />
					<field table="sq_thes_lnk" column="major" />
					<field table="sq_thes_lnk" column="minor" />
					<field table="sq_thes_rel" column="relid" />
					<field table="sq_thes_rel" column="relation" />
				</fields>
				<from>
					<table>sq_thes_lnk</table>
					<table>sq_thes_rel</table>
				</from>
				<joins>
					<join>
						<field table="sq_thes_lnk" column="relid" />
						<field table="sq_thes_rel" column="relid" />
					</join>
				</joins>
				<where>
					<equal table="sq_thes_lnk" column="linkid">:linkid</equal>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
				<order-by>
					<field table="sq_thes_rel" column="relation" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="getChildRelationsForTerm">
		<!-- Get a list of relations the passed term is a parent in. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_lnk" column="relid" />
					<field table="sq_thes_rel" column="relation" />
				</fields>
				<from>
					<table>sq_thes_lnk</table>
					<table>sq_thes_rel</table>
				</from>
				<joins>
					<join>
						<field table="sq_thes_lnk" column="relid" />
						<field table="sq_thes_rel" column="relid" />
					</join>
				</joins>
				<where>
					<equal table="sq_thes_lnk" column="major">:termid</equal>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
				<order-by>
					<field table="sq_thes_rel" column="relation" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="insertThesaurusTerm">
		<!-- Inserts a single thesaurus term. -->
		<primary>
			<insert>
				<fields table="sq_thes_term">
					<field>termid</field>
					<field>term</field>
					<field>thesid</field>
				</fields>
				<values>
					<value column="termid">:termid</value>
					<value column="term">:term</value>
					<value column="thesid">:thesid</value>
				</values>
			</insert>
		</primary>
	</query>
	<query id="getThesaurusTermIdByName">
		<!-- Get a thesaurus' term ID given the name (not case sensitive). -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term" column="termid" />
					<field table="sq_thes_term" column="term" />
				</fields>
				<from>
					<table>sq_thes_term</table>
				</from>
				<where>
					<in table="sq_thes_rel" column="LOWER(term)">:names</in> <!-- ??? -->
					<equal table="sq_thes_rel" column="thesid">:thesid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="insertThesaurusTermNote">
		<!-- Inserts a single thesaurus term. -->
		<primary>
			<insert>
				<fields table="sq_thes_term_note">
					<field>termid</field>
					<field>name</field>
					<field>value</field>
					<field>thesid</field>
				</fields>
				<values>
					<value column="termid">:termid</value>
					<value column="name">:name</value>
					<value column="value">:value</value>
					<value column="thesid">:thesid</value>
				</values>
			</insert>
		</primary>
	</query>
	<query id="getThesaurusTermNotes">
		<!-- Get a thesaurus term's notes. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_term_note" column="name" />
					<field table="sq_thes_term_note" column="value" />
				</fields>
				<from>
					<table>sq_thes_term_note</table>
				</from>
				<where>
					<equal table="sq_thes_term_note" column="thesid">:assetid</equal>
					<equal table="sq_thes_term_note" column="termid">:termid</equal>
				</where>
				<order-by>
					<field table="sq_thes_term_note" column="name" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="deleteThesaurusTermNotes">
		<!-- Delete all of a certain thesaurus term's notes. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_term_note" column="thesid">:assetid</equal>
					<equal table="sq_thes_term_note" column="termid">:termid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="insertThesaurusRelation">
		<!-- Inserts a single thesaurus relation. -->
		<primary>
			<insert>
				<fields table="sq_thes_rel">
					<field>relid</field>
					<field>relation</field>
					<field>thesid</field>
				</fields>
				<values>
					<value column="relid">:relid</value>
					<value column="relation">:relation</value>
					<value column="thesid">:thesid</value>
				</values>
			</insert>
		</primary>
	</query>
	<query id="getThesaurusLinkForRelation">
		<!-- Get a linkid for a relation, given major and minor terms, and relation name. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_lnk" column="linkid" />
					<field table="sq_thes_lnk" column="relid" />
					<field table="sq_thes_lnk" column="major" />
					<field table="sq_thes_lnk" column="minor" />
				</fields>
				<from>
					<table>sq_thes_lnk</table>
				</from>
				<where>
					<equal table="sq_thes_lnk" column="major">:major</equal>
					<equal table="sq_thes_lnk" column="minor">:minor</equal>
					<equal table="sq_thes_lnk" column="relid">:relation</equal>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="getActiveThesaurusRelations">
		<!-- Get all active relations for a given thesaurus. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_rel" column="relid" />
					<field table="sq_thes_rel" column="relation" />
				</fields>
				<from>
					<table>sq_thes_rel</table>
				</from>
				<where>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
				<order-by>
					<field table="sq_thes_rel" column="relation" />
				</order-by>
			</select>
		</primary>
	</query>
	<query id="getThesaurusRelationIdByName">
		<!-- Get a thesaurus' relation ID given the name. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_rel" column="relid" />
				</fields>
				<from>
					<table>sq_thes_rel</table>
				</from>
				<where>
					<equal table="sq_thes_rel" column="relation">:name</equal> <!-- NEEDS is-null ALTERNATE -->
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
			</select>
		</primary>
	</query>
	<query id="insertThesaurusLink">
		<!-- Inserts a single thesaurus link. -->
		<primary>
			<insert>
				<fields table="sq_thes_lnk">
					<field>linkid</field>
					<field>major</field>
					<field>minor</field>
					<field>relid</field>
					<field>thesid</field>
				</fields>
				<values>
					<value column="linkid">:linkid</value>
					<value column="major">:major</value>
					<value column="minor">:minor</value>
					<value column="relid">:relation</value>
					<value column="thesid">:thesid</value>
				</values>
			</insert>
		</primary>
	</query>
	<query id="deleteAllTermsFromThesaurus">
		<!-- Delete all of a certain thesaurus' terms. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="deleteAllLinksFromThesaurus">
		<!-- Delete all of a certain thesaurus' links. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_lnk" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="deleteAllRelationsFromThesaurus">
		<!-- Delete all of a certain thesaurus' relations. -->
		<primary>
			<delete>
				<where>
					<equal table="sq_thes_rel" column="thesid">:assetid</equal>
				</where>
			</delete>
		</primary>
	</query>
	<query id="getAbsoluteParentsInThesaurusRelation">
		<!-- Get a list of thesaurus terms that only act as parents in a relation - thus becoming the top terms in hierarchy mode. -->
		<primary>
			<select>
				<fields>
					<field table="sq_thes_lnk" column="termid" />
					<field table="sq_thes_lnk" column="term" />
				</fields>
				<from>
					<table>sq_thes_term</table>
				</from>
				<where>
					<equal table="sq_thes_term" column="thesid">:assetid</equal>
					<in table="sq_thes_term" column="termid">
						<select distinct="true">
							<fields>
								<field table="sq_thes_lnk" column="major" />
							</fields>
							<from>
								<table>sq_thes_lnk</table>
							</from>
							<where>
								<equal table="sq_thes_lnk"  column="thesid">:assetid</equal>
								<equal table="sq_thes_lnk"  column="relid">:relation</equal>
								<not-in table="sq_thes_lnk" column="major">
									<select distinct="true">
										<fields>
											<field table="sq_thes_lnk" column="minor" />
										</fields>
										<from>
											<table>sq_thes_lnk</table>
										</from>
										<where>
											<equal table="sq_thes_lnk"  column="thesid">:assetid</equal>
											<equal table="sq_thes_lnk"  column="relid">:relation</equal>
										</where>
									</select>
								</not-in>
							</where>
						</select>
					</in>
				</where>
			</select>
		</primary>
	</query>


</queries>
